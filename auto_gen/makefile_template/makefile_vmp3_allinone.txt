CC = gcc
CFLAGS = -m32 -masm=intel
INCLUDE_DIR = D:\Project\anti_vmp\InsGen\VMP3SDK\include
LD_DIR = D:\Project\anti_vmp\InsGen\VMP3SDK\Lib
LIB_NAME = VMProtectSDK32

# VMP_TMP = tmp.vmp
VMP_CON = D:\Project\anti_vmp\InsGen\VMProtect_Con.exe
VMP_CONFIG="<?xml version=\"1.0\" encoding=\"UTF-8\" ?><Document Version=\"2\"><Protection InputFileName=\"%INPUTFILENAME%\" Options=\"%OPTIONS%\"><Messages /><Folders /><Procedures /><Objects /></Protection><DLLBox><Folders /></DLLBox><Script /><LicenseManager /></Document>"
VMP_OPTIONS = 786632

PIN_DLL = F:\anti_vmp\output\instracelog_anchorfinder.dll
# PIN_DLL = Z:\data\anti_vmp\output\instracelog_anchorfinder.dll

OBJ = $(wildcard *.c)
#OBJ = mov1.c mov2.c
EXE_TARGET = $(subst .c,.exe,$(OBJ))

EXE_EXIST = $(wildcard *.exe)
VMP_EXIST = $(wildcard *.vmp.exe)
EXE_TMP = $(filter-out $(VMP_EXIST),$(EXE_EXIST))
VMP_TARGET_RAW = $(subst .exe,.vmp.exe,$(EXE_TMP))
VMP_TARGET1 = $(subst .exe,_1.vmp.exe,$(EXE_TMP))
VMP_TARGET2 = $(subst .exe,_2.vmp.exe,$(EXE_TMP))
VMP_TARGET3 = $(subst .exe,_3.vmp.exe,$(EXE_TMP))

TRACE_TARGET = $(subst .vmp.exe,.log,$(VMP_EXIST))

LOGCMP_TARGET = $(subst _1.vmp.exe,.logcmp,$(VMP_EXIST))

WordSubst = $(subst .vmp.exe,.tmp,$1)


all: exe vmp1 vmp2 vmp3 tmpclean pin

.PHONY: exe
exe: $(EXE_TARGET)

.PHONY: vmp
vmp: $(VMP_TARGET_RAW)

.PHONY: vmp1
vmp1: $(VMP_TARGET1)

.PHONY: vmp2
vmp2: $(VMP_TARGET2)

.PHONY: vmp3
vmp3: $(VMP_TARGET3)

.PHONY: pin
pin: $(TRACE_TARGET)

.PHONY: logcmp
logcmp: $(LOGCMP_TARGET)

.PHONY: clean
clean:
	echo "please use tmpclean / vmpclean / logclean / execlean / cclean"

.PHONY: tmpclean
tmpclean:
	rm -f *.tmp

.PHONY: vmpclean
vmpclean:
	rm -f *.vmp.exe

.PHONY: logclean
logclean:
	rm -f *.log

.PHONY: execlean
execlean:
	rm -f *.exe

.PHONY: cclean
cclean:
	rm -f *.c

.PHONY: clear
clear: tmpclean vmpclean logclean execlean cclean

.PHONY: debug
debug:



%.log:%.vmp.exe
	pin -t $(PIN_DLL) -o $@ -i ..\anchor.txt -- $<

%.logcmp:%_1.vmp.exe
	pin -t $(PIN_DLL) -o $@ -i ..\cmpanchor.txt -- $<

%.vmp.exe:%.exe
	echo $(VMP_CONFIG) | sed -e "s/%OPTIONS%/$(VMP_OPTIONS)/" -e "s/%INPUTFILENAME%/$</" > $(call WordSubst, $@)
	$(VMP_CON) $< $@ -pf $(call WordSubst, $@)
	$(warning VMP Compiling $< To $@)

%_1.vmp.exe:%.exe
	echo $(VMP_CONFIG) | sed -e "s/%OPTIONS%/$(VMP_OPTIONS)/" -e "s/%INPUTFILENAME%/$</" > $(call WordSubst, $@)
	$(VMP_CON) $< $@ -pf $(call WordSubst, $@)
	$(warning VMP Compiling $< To $@)

%_2.vmp.exe:%.exe
	echo $(VMP_CONFIG) | sed -e "s/%OPTIONS%/$(VMP_OPTIONS)/" -e "s/%INPUTFILENAME%/$</" > $(call WordSubst, $@)
	$(VMP_CON) $< $@ -pf $(call WordSubst, $@)
	$(warning VMP Compiling $< To $@)

%_3.vmp.exe:%.exe
	echo $(VMP_CONFIG) | sed -e "s/%OPTIONS%/$(VMP_OPTIONS)/" -e "s/%INPUTFILENAME%/$</" > $(call WordSubst, $@)
	$(VMP_CON) $< $@ -pf $(call WordSubst, $@)
	$(warning VMP Compiling $< To $@)

%.exe:%.c
	$(CC) $(CFLAGS) $< -o $@ -I$(INCLUDE_DIR) -L$(LD_DIR) -l$(LIB_NAME)
	$(warning CC $< -o $@)

%.log:%.vmp.exe
	pin -t $(PIN_DLL) -o $@ -i ..\anchor.txt -- $<
